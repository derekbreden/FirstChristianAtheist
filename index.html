<!doctype html>
<html>
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
  />
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="/apple-touch-icon.png?v=5"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="/favicon-32x32.png?v=5"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="/favicon-16x16.png?v=5"
  />
  <link rel="manifest" href="/site.webmanifest?v=5" />
  <link rel="mask-icon" href="/safari-pinned-tab.svg?v=5" color="#5bbad5" />
  <link rel="shortcut icon" href="/favicon.ico?v=5" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <meta name="theme-color" content="#ffffff" />
  <style>
    @font-face {
      font-family: "Montserrat";
      font-style: normal;
      font-weight: 100 900;
      src: url("/Montserrat-VariableFont_wght.ttf") format("truetype");
    }
    * {
      font-family: Montserrat;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }
    html {
      height: 100%;
    }
    body {
      min-height: 100%;
      position: relative;
      font-size: 14px;
      display: flex;
      justify-content: center;
      background-image: repeating-linear-gradient(
        90deg,
        #bbc8d7 0%,
        #bbc8d7 calc((100% - 480px) / 2),
        #fff calc((100% - 480px) / 2),
        #fff calc((100% - 480px) / 2 + 480px),
        #bbc8d7 calc((100% - 480px) / 2 + 480px),
        #bbc8d7 100%
      );
      color: #26323e;
    }
    main-content {
      display: flex;
      flex-direction: column;
      padding: 44px 40px 20px 40px;
      max-width: 480px;
      width: 100%;
    }
    @media (max-width: 480px) {
      body {
        background: #fff;
      }
      main-content {
        padding: 44px 20px 20px 20px;
      }
    }
    a,
    a:visited,
    a:active {
      color: #26323e;
      font-weight: 500;
    }
    h2 {
      margin-top: 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    h2 button {
      margin-left: 5px;
    }
    h3 {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    p {
      margin-top: 10px;
    }
    p img {
      max-width: 100%;
      border-radius: 10px;
    }
    p[quote] {
      padding: 10px;
      border-left: 2px solid #999;
      background: #f5f5f5;
    }
    p[quote] + p[quote] {
      margin-top: 0;
    }
    p[bold] {
      font-weight: 600;
    }
    p[ellipsis] {
      margin-bottom: 10px;
    }
    back-wrapper {
      margin-top: 20px;
      display: flex;
    }
    li {
      margin-top: 10px;
      margin-left: 20px;
    }
    debug {
      white-space: pre;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      background: #fff;
      right: 0;
      height: 44px;
      display: flex;
      align-items: center;
      box-shadow: 0px 0px 5px #26323e;
      z-index: 1;
    }
    header h1 {
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      margin: 0 20px;
    }
    header h1 img {
      height: 24px;
      width: 24px;
      margin-right: 5px;
    }
    header hamburger {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 74px;
      padding: 10px 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    header hamburger line {
      border: 2px solid #27323e;
      border-bottom-width: 1px;
      border-radius: 2px;
      width: 100%;
    }
    menu {
      display: none;
      flex-direction: column;
      position: fixed;
      top: 0;
      right: 0;
      z-index: 3;
      background: #fff;
      box-shadow: 0px 0px 5px #26323e;
      border-radius: 0 0 0 2px;
    }
    menu signed-in,
    menu sign-in,
    modal {
      display: flex;
      flex-direction: column;
      padding: 20px 20px 15px 20px;
      position: relative;
      width: 280px;
    }
    menu signed-in {
      display: none;
    }
    menu signed-in > *,
    menu sign-in > *,
    modal > * {
      margin-bottom: 5px;
    }
    menu links {
      display: flex;
      flex-direction: column;
    }
    menu links a {
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      padding: 10px 20px;
      border-bottom: 1px solid #999;
    }
    a[big] {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      text-decoration: none;
      border-radius: 2px;
      border: 1px solid #4a5;
      color: #fff;
      background: #4a5;
      padding: 10px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    modal-bg {
      display: none;
      background: #00000077;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 2;
    }
    input,
    textarea {
      font-size: 14px;
      width: 240px;
      border-radius: 2px;
      border: 1px solid #26323e;
      padding: 10px;
    }
    button {
      cursor: pointer;
      font-size: 14px;
      -webkit-appearance: none;
      border-radius: 2px;
      border: 0;
      background: #26323e;
      border: 1px solid #26323e;
      color: #fff;
      padding: 10px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    button[alt] {
      background: #f5f5f5;
      color: #26323e;
      border: 1px solid #999;
    }
    button[small] {
      padding: 2px 10px;
    }
    button[faint] {
      opacity: 0.5;
    }
    pass,
    info,
    error {
      padding: 10px 10px 10px 36px;
      position: relative;
      background: #ffeeee;
      border: 1px solid #b66;
      color: #b66;
      border-radius: 2px;
      max-width: 100%;
      display: none;
      flex-direction: column;
      font-weight: 500;
    }
    pass,
    info[show],
    error[show] {
      display: flex;
    }
    pass::before,
    info::before,
    error::before {
      content: "!";
      position: absolute;
      left: 10px;
      top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 20px;
      background: #b66;
      color: #ffeeee;
      font-size: 14px;
      font-weight: 700;
      height: 17px;
      width: 17px;
    }
    info {
      border-color: #48c;
      background: #e0f0ff;
      color: #48c;
    }
    info::before {
      content: "i";
      background: #48c;
      color: #e0f0ff;
    }
    pass {
      padding: 2px 10px 2px 34px;
      border-color: #4a5;
      background: #f0fff0;
      color: #4a5;
      display: inline-flex;
      display: none;
    }
    pass::before {
      top: 3.5px;
      font-size: 10px;
      height: 15px;
      width: 15px;
      content: "✓";
      background: #4a5;
      color: #f0fff0;
    }
    password-wrapper {
      display: flex;
      align-items: center;
    }
    password-wrapper input {
      width: 218px;
    }
    password-help {
      display: flex;
      align-items: center;
      padding: 10px 0 9px 5px;
    }
    password-help::before {
      content: "?";
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 20px;
      background: #48c;
      color: #e0f0ff;
      font-weight: 600;
      height: 17px;
      width: 17px;
    }
    modal {
      position: fixed;
      display: none;
      flex-direction: column;
      z-index: 4;
      top: 64px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border-radius: 2px;
      box-shadow: 0px 0px 5px #26323e;
    }
    add-new {
      display: flex;
      flex-direction: column;
    }
    add-new > * {
      margin-bottom: 5px;
    }
    add-new > *:last-child {
      margin-bottom: 0;
    }
    add-new input,
    add-new textarea,
    add-new button {
      width: 100%;
    }
    [add-new-article] {
      display: none;
      margin-top: 20px;
    }
    [add-new-article] button {
      width: 100%;
    }
    comments {
      display: flex;
      flex-direction: column;
    }
    comments > add-new:first-child {
      padding: 10px;
      border: 1px solid #ddd;
    }
    comments comment {
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      border-radius: 2px;
      margin-bottom: 20px;
      padding: 10px;
    }
    comments comment:last-child {
      margin-bottom: 0;
    }
    comments comment comment {
      margin-top: 10px;
    }
    comments comment comment + comment {
      margin-top: -10px;
    }
    comments comment p {
      margin-top: 5px;
    }
    comments comment pass,
    comments comment info {
      margin-top: 10px;
    }
    comments comment info b {
      margin-bottom: 5px;
    }
    comments > add-new:first-child {
      margin: 20px 0;
    }
    comments > add-new:not(:first-child) {
      margin: 0 0 20px 0;
      border: 1px solid #ddd;
      border-radius: 2px;
      margin-bottom: 20px;
      padding: 10px;
    }
    articles > add-new:last-child {
      margin: 20px 0 0 0;
    }
    comment add-new {
      margin-top: 10px;
    }
    reply-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-top: 10px;
    }
    display-name-wrapper {
      padding-bottom: 5px;
    }
    articles {
      display: flex;
      flex-direction: column;
    }
    articles article + article {
      margin-top: 21px;
      position: relative;
    }
    articles article + article::before {
      content: "";
      display: block;
      position: absolute;
      top: 0px;
      left: 20px;
      right: 20px;
      border-top: 1px solid #999;
    }
    articles-loading {
      display: flex;
      display: none;
      flex-direction: column;
      animation: loading 1.5s ease-in-out infinite;
    }
    articles-loading h2 {
      background: #ddd;
      width: 80%;
      height: 32px;
    }
    articles-loading p {
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    articles-loading p::before,
    articles-loading p::after {
      content: "";
      display: block;
      width: 100%;
      border-top: 16px solid #ddd;
      border-bottom: 16px solid #ddd;
      height: 10px;
    }
    articles-loading p::after {
      margin-top: 10px;
      width: 33%;
      border-bottom: none;
    }
    @keyframes loading {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
      100% {
        opacity: 1;
      }
    }
    #loading-svg {
      width: 100%;
    }
    #loading-svg #circle1 {
      animation: circle1 3s ease-in-out infinite;
    }
    @keyframes circle1 {
      0% {
        stroke-dashoffset: 468px;
      }
      50% {
        stroke-dashoffset: 936px;
      }
      100% {
        stroke-dashoffset: 1404px;
      }
    }
    #loading-svg #circle2 {
      animation: circle2 3s ease-in-out infinite;
    }
    @keyframes circle2 {
      0% {
        stroke-dashoffset: 1466.65px;
      }
      50% {
        stroke-dashoffset: 2933.3px;
      }
      100% {
        stroke-dashoffset: 4409.95px;
      }
    }
    #loading-svg #feather1 {
      animation: feather1 3s ease-in-out infinite;
    }
    @keyframes feather1 {
      0% {
        stroke-dashoffset: 699.26px;
      }
      50% {
        stroke-dashoffset: 1398.52px;
      }
      100% {
        stroke-dashoffset: 2087.78px;
      }
    }
    #loading-svg #feather2 {
      animation: feather2 3s ease-in-out infinite;
    }
    @keyframes feather2 {
      0% {
        stroke-dashoffset: 603.78px;
      }
      50% {
        stroke-dashoffset: 1210.56px;
      }
      100% {
        stroke-dashoffset: 1814.34px;
      }
    }
    #loading-svg #feather3 {
      animation: feather3 3s ease-in-out infinite;
    }
    @keyframes feather3 {
      0% {
        stroke-dashoffset: 424.74px;
      }
      50% {
        stroke-dashoffset: 849.48px;
      }
      100% {
        stroke-dashoffset: 1274.22px;
      }
    }
    #loading-svg #body {
      animation: body 3s ease-in-out infinite;
    }
    @keyframes body {
      0% {
        stroke-dashoffset: 891.24px;
      }
      50% {
        stroke-dashoffset: 1782.48px;
      }
      100% {
        stroke-dashoffset: 2673.72px;
      }
    }
    #loading-svg #tail {
      animation: tail 3s ease-in-out infinite;
    }
    @keyframes tail {
      0% {
        stroke-dashoffset: 247.65px;
      }
      50% {
        stroke-dashoffset: 495.3px;
      }
      100% {
        stroke-dashoffset: 743.95px;
      }
    }
    #loading-svg #heart {
      animation: heart 3s ease-in-out infinite;
    }
    @keyframes heart {
      0% {
        stroke-dashoffset: 156.85px;
      }
      50% {
        stroke-dashoffset: 313.7px;
      }
      100% {
        stroke-dashoffset: 470.55px;
      }
    }
  </style>
  <head>
    <title>First Christian Atheist</title>
  </head>
  <body>
    <header>
      <h1 href="/">
        <img src="/logo.png" alt="A logo consisting of a dove and a heart" />
        First Christian Atheist
      </h1>
      <hamburger>
        <line></line>
        <line></line>
        <line></line>
      </hamburger>
    </header>
    <menu>
      <links>
        <a href="/">Home</a>
        <a href="/topics">Topics</a>
      </links>
      <sign-in>
        <input
          placeholder="Email"
          type="email"
          autocomplete="email"
          maxlength="255"
        />
        <password-wrapper>
          <input
            placeholder="Password"
            type="password"
            autocomplete="current-password"
          />
          <password-help></password-help>
        </password-wrapper>
        <button submit>Sign up / Sign in</button>
        <button alt cancel>Cancel</button>
        <error></error>
        <info></info>
      </sign-in>
      <signed-in>
        <button sign-out>Log out</button>
      </signed-in>
    </menu>
    <main-content>
      <debug></debug>
      <loading>
      <svg
        id="loading-svg"
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        width="410"
        height="400"
        viewBox="-3, -3, 406, 398"
      >
        <g id="svgg">
          <path
            id="circle1"
            d="M47.629 64.720 C 2.004 115.086,-12.012 184.306,9.306 253.990 L 11.260 260.377 17.696 261.490 C 21.236 262.102,28.843 263.641,34.601 264.910 C 40.358 266.179,45.252 267.035,45.475 266.811 C 46.010 266.277,44.896 262.580,42.478 256.860 C 22.272 209.065,25.951 148.335,51.381 109.875 L 55.016 104.379 53.955 100.158 C 51.176 89.093,51.143 73.415,53.880 64.392 C 55.941 57.600,53.986 57.703,47.629 64.720"
            fill="none"
            stroke="#26323e"
            stroke-width="4"
            stroke-dasharray="468"
            stroke-linecap="round"
          ></path>
          <path
            id="circle2"
            d="M189.442 0.628 C 188.709 1.814,192.759 12.761,196.914 20.826 L 200.661 28.099 214.215 28.513 C 315.677 31.613,389.037 126.559,366.893 226.116 C 351.742 294.234,300.989 343.116,230.697 357.292 C 197.861 363.914,169.671 360.909,128.579 346.408 C 97.053 335.282,90.967 334.709,75.764 341.432 C 69.989 343.986,70.620 344.960,83.967 354.083 C 120.226 378.866,151.439 388.753,195.035 389.265 C 241.383 389.808,273.955 380.758,309.752 357.392 C 359.739 324.763,387.230 283.891,398.103 226.036 C 399.854 216.717,400.673 177.414,399.340 166.612 C 388.997 82.768,322.965 15.515,237.344 1.622 C 228.551 0.195,190.201 -0.600,189.442 0.628"
            fill="none"
            stroke="#26323e"
            stroke-width="4"
            stroke-dasharray="1466.65"
            stroke-linecap="round"
          ></path>
          <path
            id="feather1"
            d="M51.232 132.397 C 48.767 139.248,47.582 155.831,48.868 165.475 C 52.613 193.572,71.632 216.566,97.851 224.695 C 105.734 227.138,123.656 230.029,131.545 230.129 C 138.427 230.216,138.166 231.085,130.849 232.442 C 120.253 234.408,91.114 234.271,81.322 232.209 C 69.348 229.688,68.974 230.030,73.507 239.339 C 83.342 259.534,110.984 267.985,147.043 261.822 C 156.591 260.190,156.827 260.308,150.134 263.367 C 138.328 268.764,122.301 272.302,109.256 272.391 C 106.319 272.411,113.170 280.137,119.134 283.531 C 138.203 294.381,174.368 293.275,194.484 281.227 C 210.153 271.843,213.254 253.206,202.215 234.775 C 193.503 220.231,179.704 210.630,148.430 197.354 C 105.552 179.152,75.308 158.667,57.102 135.493 C 54.137 131.719,51.900 130.539,51.232 132.397"
            fill="none"
            stroke="#26323e"
            stroke-width="4"
            stroke-dasharray="699.26"
            stroke-linecap="round"
          ></path>
          <path
            id="feather2"
            d="M104.802 6.773 C 92.454 16.061,82.669 28.586,76.509 42.989 C 66.177 67.144,68.024 98.482,81.126 121.322 C 96.298 147.768,115.927 162.170,159.901 179.118 C 196.880 193.369,216.959 210.702,224.150 234.580 C 226.590 242.682,227.785 241.165,227.702 230.067 C 227.534 207.368,219.783 194.865,192.166 172.746 C 144.920 134.905,123.245 93.540,128.528 51.299 L 129.650 42.326 126.714 37.490 C 122.083 29.860,117.717 20.857,114.307 11.901 C 110.619 2.214,110.762 2.291,104.802 6.773"
            fill="none"
            stroke="#26323e"
            stroke-width="4"
            stroke-dasharray="603.78"
          ></path>
          <path
            id="feather3"
            d="M155.268 17.686 C 146.536 28.098,142.159 55.494,146.104 75.041 C 152.569 107.073,169.901 133.027,201.983 158.721 C 221.679 174.494,230.720 184.240,236.087 195.485 C 244.009 212.085,240.170 177.616,231.495 154.255 C 222.840 130.948,212.198 111.118,178.163 54.876 C 168.639 39.136,158.017 19.423,158.017 17.486 C 158.017 16.169,156.444 16.284,155.268 17.686"
            fill="none"
            stroke="#26323e"
            stroke-width="4"
            stroke-dasharray="424.74"
          ></path>
          <path
            id="body"
            d="M285.289 161.996 C 267.560 165.542,253.918 179.885,244.930 204.427 C 240.914 215.394,233.388 238.183,233.388 239.377 C 233.388 247.018,257.894 223.935,267.471 207.273 C 279.732 185.941,293.238 180.203,308.595 189.802 C 310.520 191.005,310.521 191.003,307.558 194.790 C 301.375 202.694,297.522 210.971,290.820 230.744 C 270.178 291.645,239.327 313.698,167.823 318.664 C 147.934 320.045,146.559 320.174,135.207 321.724 C 116.285 324.306,96.198 330.078,96.198 332.932 C 96.198 333.928,96.716 334.249,98.512 334.369 C 119.841 335.791,131.301 337.176,147.107 340.241 C 198.585 350.224,231.693 345.732,264.034 324.376 C 295.970 303.288,312.353 276.738,318.957 235.372 C 322.388 213.877,329.840 201.085,344.296 191.872 C 347.562 189.791,347.824 188.686,345.289 187.678 C 336.241 184.078,331.026 180.875,324.824 175.106 C 311.406 162.627,300.393 158.975,285.289 161.996"
            fill="none"
            stroke="#26323e"
            stroke-width="4"
            stroke-dasharray="891.24"
          ></path>
          <path
            id="tail"
            d="M20.115 278.570 C 18.817 281.952,35.364 307.083,49.917 323.831 C 55.458 330.208,54.584 330.072,62.229 325.758 C 78.496 316.581,99.646 309.137,121.818 304.785 C 125.487 304.064,127.643 301.488,124.577 301.488 C 124.003 301.488,119.466 300.317,114.494 298.886 C 86.876 290.937,54.395 283.113,36.364 280.067 C 21.398 277.539,20.541 277.460,20.115 278.570"
            fill="none"
            stroke="#26323e"
            stroke-width="4"
            stroke-dasharray="247.65"
          ></path>
          <path
            id="heart"
            d="M294.299 101.452 C 286.187 104.078,282.509 114.112,286.529 122.645 C 288.350 126.510,309.406 147.682,311.070 147.321 C 313.186 146.863,333.344 126.032,334.949 122.645 C 342.025 107.715,324.871 93.463,313.195 104.571 C 310.617 107.024,310.506 107.062,309.617 105.793 C 306.897 101.910,299.425 99.792,294.299 101.452"
            fill="none"
            stroke="#26323e"
            stroke-width="4"
            stroke-dasharray="156.85"
          ></path>
        </g>
      </svg>
      </loading>
      <articles-loading>
        <h2></h2>
        <p></p>
        <p></p>
      </articles-loading>
      <articles></articles>
      <p add-new-article>
        <button alt>Add topic</button>
      </p>
      <comments></comments>
    </main-content>
    <modal-bg></modal-bg>
    <modal password-help>
      <input
        placeholder="Email"
        type="email"
        autocomplete="email"
        maxlength="255"
      />
      <button submit>Reset password</button>
      <button alt cancel>Cancel</button>
      <error></error>
      <info></info>
    </modal>
    <modal password-reset>
      <input
        placeholder="New password"
        type="password"
        autocomplete="new-password"
      />
      <button submit>Set password</button>
      <button alt cancel>Cancel</button>
      <error></error>
      <info></info>
    </modal>
    <modal info>
      <info show></info>
      <button close>Okay</button>
    </modal>
    <modal error>
      <error show></error>
      <button close>Okay</button>
    </modal>
  </body>
  <script>
    // Debug and library setup
    const $ = (selector_or_flint, flint_args_or_element) => {
      const addHelpers = (element, $all) => {
        element.on = element.addEventListener.bind(element);
        // Allow forEach to be called even if 1 element is returned
        element.forEach = (f) => $all.forEach(f);
        element.$ = (selector) => $(selector, element);
      };
      if (selector_or_flint.substr(0, 1) === "\n") {
        let flint = selector_or_flint;
        const flint_args = flint_args_or_element;
        flint = flint
          .split("\n")
          .filter((x) => x.trim() !== "")
          .map((original_text) => {
            return {
              text: original_text.trim(),
              level: original_text.match(/^([\s]*)/)[0].length,
            };
          });

        // Helper function to create elements recursively
        const createElement = (nodes, index = 0, parent = null) => {
          if (index >= nodes.length) return null;
          const node = nodes[index];
          const attributes = (node.text.match(/\[[^\]]*\]/g) || []).map(
            (attr) => {
              let [key, value] = attr.slice(1, -1).split("=");
              if (value) {
                if (value.startsWith("$")) {
                  const arg_index = parseInt(value.slice(1)) - 1;
                  value = flint_args[arg_index];
                }
              } else {
                value = "";
              }
              return {
                key,
                value,
              };
            },
          );
          node.text = node.text.replace(/\[[^\]]*\]/g, "");
          const parts = node.text.split(" ");
          let tag = parts[0];
          const rest = parts.slice(1).join(" ");

          let element = null;

          if (tag.startsWith("$")) {
            const arg_index = parseInt(tag.slice(1)) - 1;
            const arg = flint_args[arg_index];

            if (typeof arg === "string") {
              element = document.createTextNode(arg);
            } else if (Array.isArray(arg)) {
              element = document.createDocumentFragment();
              arg.forEach((child) => element.appendChild(child));
            } else {
              element = arg;
            }
          } else {
            element = document.createElement(tag);
            attributes.forEach((attr) => {
              if (
                attr.value !== false &&
                attr.value !== null &&
                attr.value !== undefined
              ) {
                element.setAttribute(attr.key, attr.value);
              }
            });
            if (rest.includes("$")) {
              const content = rest.replace(/\$\d+/g, (match) => {
                const arg_index = parseInt(match.slice(1)) - 1;
                return flint_args[arg_index] !== undefined
                  ? flint_args[arg_index]
                  : match;
              });
              if (element.tagName === "TEXTAREA") {
                element.value = content;
              } else {
                element.innerText = content;
              }
            } else if (rest.length) {
              element.innerText = rest;
            }
          }

          if (parent) {
            parent.appendChild(element);
          }

          const children = [];
          let child_level = false;
          for (let i = index + 1; i < nodes.length; i++) {
            if (nodes[i].level > node.level) {
              if (!child_level) {
                child_level = nodes[i].level;
              }
              if (nodes[i].level === child_level) {
                createElement(nodes, i, element);
              }
            } else {
              break;
            }
          }

          return element;
        };
        const rootElements = document.createElement("div");
        let child_level = false;
        for (let i = 0; i < flint.length; i++) {
          if (!child_level) {
            child_level = flint[i].level;
          }
          if (flint[i].level === child_level) {
            const rootElement = createElement(flint, i, rootElements);
          }
        }
        if (rootElements.children.length === 1) {
          addHelpers(rootElements.children[0]);
          return rootElements.children[0];
        } else {
          addHelpers(rootElements);
          return rootElements;
        }
      } else {
        const element = flint_args_or_element || document;
        const selector = selector_or_flint;
        const $all = element.querySelectorAll(selector);
        $all.forEach((element) => addHelpers(element, $all));
        if ($all.length === 1) {
          return $all[0];
        } else if ($all.length === 0) {
          return null;
        } else {
          return $all;
        }
      }
    };
    const debug = function () {
      let to_render = [...arguments];
      if (to_render[0] && to_render[0].message) {
        to_render = {
          message: to_render[0].message,
          // filename: to_render[0].filename,
          lineno: to_render[0].lineno,
          colno: to_render[0].colno,
        };
      } else if (to_render.length === 1) {
        to_render = to_render[0];
      }
      $("debug").innerHTML = JSON.stringify(to_render, null, 2);
    };
    window.addEventListener("error", ($error) => {
      debug($error);
    });

    // Read URL
    let path = "/";
    const paths = window.location.pathname.split("/").filter((x) => x);
    let reset_token_uuid = "";
    if (paths[0] === "reset") {
      reset_token_uuid = paths[1] || "";
    } else if (paths[0] === "article" && paths[1]) {
      path = "/" + paths[0] + "/" + paths[1];
    } else if (paths[0]) {
      path = "/" + paths[0];
    }

    // Page level rendering
    const loadingPage = () => {
      $("[add-new-article]").style.display = "none";
      $("loading").style.display = "flex";
      $("articles").style.display = "none";
      $("comments").style.display = "none";
    };
    const renderPage = (page_path, articles, comments, add_new) => {
      if (path !== page_path) {
        path = page_path;
        history.replaceState({}, "", page_path);
      }
      if (add_new) {
        $("[add-new-article]").style.display = "flex";
      }
      $("loading").style.display = "none";
      $("articles").style.display = "flex";
      $("comments").style.display = "flex";
      $("articles").replaceChildren(
        ...articles.map((article) => {
          let $article_body = markdownToElements(article.body);
          let characters_used = 0;
          let trimmed = false;
          if (path === "/topics") {
            article.edit = false;
            $article_body = $article_body.reduce((acc, child) => {
              characters_used += child.textContent.length;
              if (characters_used < 280) {
                acc.push(child);
              } else {
                trimmed = true;
              }
              return acc;
            }, []);
            let $more = null;
            if (trimmed) {
              const $more_wrapper = $(
                `
                p[ellipsis] ...
                button[alt][small][more] Read more
                `,
              );
              $more = $more_wrapper.$("[more]");
              $article_body.push($more_wrapper);
            } else {
              $more = $(
                `
                button[alt][small][more] Read more
                `,
              );
              $article_body.push($more);
            }
            $more.on("click", () => {
              path = "/article/" + article.slug;
              history.pushState({}, "", path);
              loadingPage();
              startSession();
            });
          }
          const $article = $(
            `
            article
              h2
                $1
                $2
              $3
            `,
            [
              article.title,
              article.edit
                ? $(
                    `
                    button[edit][small][alt][faint] Edit
                    `,
                    [],
                  )
                : [],
              $article_body,
            ],
          );
          if (article.edit) {
            $article.$("[edit]").on("click", () => {
              showAddNewArticle(article, $article);
            });
          }
          return $article;
        }),
      );
      $("articles a")?.forEach(($a) => {
        const new_path = $a.getAttribute("href");
        if (new_path.substr(0, 1) === "/") {
          $a.on("click", ($event) => {
            $event.preventDefault();
            if (path !== new_path) {
              path = new_path;
              history.pushState({}, "", path);
              loadingPage();
            }
            startSession();
          });
        }
      });
      if (path.substr(0, 8) === "/article") {
        const $back = $(
          `
          back-wrapper
            button[back][small][alt] ‹ Back to topics
          `,
          [],
        );
        $("articles").prepend($back);
        $back.on("click", () => {
          path = "/topics";
          history.pushState({}, "", path);
          loadingPage();
          startSession();
        });
      }
      const $comments = comments.map((comment) => {
        let note = comment.note || "";
        let note_title = note.slice(0, note.indexOf(" "));
        note_title =
          {
            ESCALATING: "Escalation",
            JUDGMENTAL: "Judgmental",
            MISUNDERSTANDING: "Misunderstanding",
            OFFTOPIC: "Off topic",
          }[note_title] || note_title;
        const note_body = note.slice(note.indexOf(" ") + 1);
        let $comment = $(
          `
          comment
            h3
              $1
              $2
            $3
            $4
            $5
          `,
          [
            comment.display_name + ":",
            comment.edit
              ? $(
                  `
                  button[edit][small][alt][faint] Edit
                  `,
                  [],
                )
              : [],
            markdownToElements(comment.body),
            comment.note
              ? $(
                  `
                  info-wrapper
                    info[show]
                      b $1
                      span $2
                  `,
                  [note_title, note_body],
                )
              : [],
            $(
              `
              reply-wrapper
                button[small][reply] Reply
                pass
                  b OK
              `,
            ),
          ],
        );
        $comment.$("[reply]").on("click", () => {
          $comment.$(":scope > reply-wrapper").style.display = "none";
          showAddNewComment(null, null, comment, $comment);
        });
        $comment.$("[edit]")?.on("click", () => {
          showAddNewComment(comment, $comment);
        });
        comment.$comment = $comment;
        return $comment;
      });
      const $root_comments = comments
        .filter((c) => !c.parent_comment_id)
        .map((c) => c.$comment);
      comments.forEach((comment) => {
        if (comment.parent_comment_id) {
          const parent = comments.find(
            (c) => c.comment_id === comment.parent_comment_id,
          );

          // When all ancestors are an only child we act like a sibling instead of a child
          let ancestor = parent;
          let found_siblings = false;
          while (!found_siblings && ancestor.parent_comment_id) {
            const siblings = comments.filter(
              (c) =>
                c.parent_comment_id === ancestor.parent_comment_id &&
                c.comment_id !== ancestor.comment_id,
            );
            if (siblings.length === 0) {
              ancestor = comments.find(
                (c) => c.comment_id === ancestor.parent_comment_id,
              );
            } else {
              siblings.forEach((sibling) => {
                const $reply = sibling.$comment.$(
                  ":scope > reply-wrapper [reply]",
                );
                $reply.setAttribute("alt", "");
                $reply.setAttribute("faint", "");
              });
              found_siblings = true;
            }
          }
          ancestor.$comment.appendChild(comment.$comment);
          const $reply = parent.$comment.$(":scope > reply-wrapper [reply]");
          $reply.setAttribute("alt", "");
          $reply.setAttribute("faint", "");
        }
      });
      $("comments").replaceChildren(...$root_comments);
      showAddNewComment();
    };
    window.addEventListener("popstate", () => {
      const new_paths = window.location.pathname.split("/").filter((x) => x);
      let new_path = "/";
      if (new_paths[0]) {
        new_path = "/" + new_paths[0];
      }
      if (path !== new_path) {
        path = new_path;
        loadingPage();
        startSession();
      }
    });

    // Add new article
    const showAddNewArticle = (article, $article) => {
      const $add_new = $(
        `
        add-new[article]
          input[title][placeholder=Title][maxlength=140][value=$1]
          textarea[body][placeholder=Content][rows=20][maxlength=4000] $2
          button[submit] $3
          button[alt][cancel] Cancel
        `,
        article
          ? [article.title, article.body, "Save changes"]
          : ["", "", "Add topic"],
      );

      const addArticleError = (error) => {
        $add_new.appendChild(
          $(
            `
            error[show] $1
            `,
            [error],
          ),
        );
      };

      $add_new.$("[title]").on("focus", () => {
        $add_new.$("error")?.remove();
      });
      $add_new.$("[body]").on("focus", () => {
        $add_new.$("error")?.remove();
      });
      $add_new.$("[cancel]").on("click", () => {
        if ($article) {
          $add_new.replaceWith($article);
        } else {
          $add_new.remove();
          $("[add-new-article]").style.display = "block";
        }
      });
      $add_new.$("[submit]").on("click", () => {
        $add_new.$("error")?.remove();
        const title = $add_new.$("[title]").value;
        const body = $add_new.$("[body]").value;
        if (!title) {
          addArticleError("Please enter a title");
          return;
        }
        if (!body) {
          addArticleError("Please enter some content");
          return;
        }
        $add_new.appendChild(
          $(
            `
              info[show] Validating...
            `,
          ),
        );
        $add_new.$("[title]").setAttribute("disabled", "");
        $add_new.$("[body]").setAttribute("disabled", "");
        fetch("/session", {
          method: "POST",
          body: JSON.stringify({
            session_uuid,
            path,
            title,
            body,
            article_id: article ? article.article_id : undefined,
          }),
        })
          .then((response) => response.json())
          .then(function (data) {
            if (data.error || !data.success) {
              $add_new.$("info")?.remove();
              $add_new.$("[title]").removeAttribute("disabled");
              $add_new.$("[body]").removeAttribute("disabled");
              addArticleError(data.error || "Server error");
              return;
            }
            startSession();
          })
          .catch(function (error) {
            $add_new.$("info")?.remove();
            addArticleError("Network error");
          });
      });
      if ($article) {
        $article.replaceWith($add_new);
      } else {
        $("articles").appendChild($add_new);
      }
      $add_new.$("[body]").focus();
    };
    $("[add-new-article]").on("click", ($event) => {
      $event.preventDefault();
      $("[add-new-article]").style.display = "none";
      showAddNewArticle();
    });

    // Add new comment
    const showAddNewComment = (
      comment,
      $comment,
      parent_comment,
      $parent_comment,
    ) => {
      const $add_new = $(
        `
        add-new[comment]
          input[display-name][placeholder=Your name][maxlength=50][value=$1]
          textarea[body][placeholder=Comment][rows=5][maxlength=1000] $2
          button[submit] $3
          button[alt][cancel] Cancel
        `,
        comment
          ? [display_name, comment.body, "Save changes"]
          : parent_comment
            ? [display_name, "", "Reply"]
            : [display_name, "", "Add comment"],
      );
      if (comment) {
        $add_new.$("[cancel]").on("click", () => {
          $add_new.replaceWith($comment);
        });
      } else if ($parent_comment) {
        $add_new.$("[cancel]").on("click", () => {
          $parent_comment.$(":scope > reply-wrapper").style.display = "flex";
          $add_new.remove();
        });
      } else {
        $add_new.$("[cancel]").remove();
      }
      const addCommentError = (error) => {
        $add_new.appendChild(
          $(
            `
            error[show] $1
            `,
            [error],
          ),
        );
      };
      $add_new.$("[display-name]").on("focus", () => {
        $add_new.$("error")?.remove();
      });
      $add_new.$("[body]").on("focus", () => {
        $add_new.$("error")?.remove();
      });
      const hideDisplayNameInput = () => {
        const $display_name = $add_new.$("[display-name]");
        if (display_name && $display_name) {
          const $display_name_wrapper = $(
            `
            display-name-wrapper
              b $1
            `,
            [display_name + ":"],
          );
          $display_name_wrapper.on("click", () => {
            $display_name_wrapper.replaceWith($display_name);
            $display_name.focus();
          });
          $display_name.replaceWith($display_name_wrapper);
        }
      };
      const saveDisplayName = () => {
        if (display_name === $add_new.$("[display-name]").value) {
          hideDisplayNameInput();
          return;
        }
        display_name = $add_new.$("[display-name]").value;
        $add_new.$("[display-name]").setAttribute("disabled", "");
        if (!display_name) {
          addCommentError("Please enter your name");
          return;
        }
        $add_new.appendChild(
          $(
            `
              info[show] Validating...
            `,
          ),
        );
        fetch("/session", {
          method: "POST",
          body: JSON.stringify({
            session_uuid,
            display_name,
          }),
        })
          .then((response) => response.json())
          .then(function (data) {
            $add_new.$("[display-name]")?.removeAttribute("disabled");
            $add_new.$("info")?.remove();
            if (data.error || !data.success) {
              addCommentError(data.error || "Server error");
              display_name = "";
            }
            hideDisplayNameInput();
          })
          .catch(function (error) {
            $add_new.$("[display-name]")?.removeAttribute("disabled");
            $add_new.$("info")?.remove();
            addCommentError("Network error");
          });
      };
      $add_new.$("[display-name]").on("blur", () => {
        saveDisplayName();
      });
      hideDisplayNameInput();
      $add_new.$("[submit]").on("click", () => {
        $add_new.$("error")?.remove();
        display_name = $add_new.$("[display-name]")?.value || display_name;
        const body = $add_new.$("[body]").value;
        if (!display_name) {
          addCommentError("Please enter your name");
          return;
        }
        if (!body) {
          addCommentError("Please enter a comment");
          return;
        }
        $add_new.appendChild(
          $(
            `
              info[show] Validating...
            `,
          ),
        );
        $add_new.$("[body]").setAttribute("disabled", "");
        $add_new.$("[display-name]")?.setAttribute("disabled", "");
        fetch("/session", {
          method: "POST",
          body: JSON.stringify({
            session_uuid,
            path,
            display_name,
            body,
            comment_id: comment ? comment.comment_id : undefined,
            parent_comment_id: parent_comment
              ? parent_comment.comment_id
              : comment && comment.parent_comment_id
                ? comment.parent_comment_id
                : undefined,
          }),
        })
          .then((response) => response.json())
          .then(function (data) {
            if (data.error || !data.success) {
              $add_new.$("info")?.remove();
              $add_new.$("[body]").removeAttribute("disabled");
              $add_new.$("[display-name]")?.removeAttribute("disabled");
              addCommentError(data.error || "Server error");
              return;
            }
            if (!comment && !parent_comment) {
              $add_new.$("[body]").value = "";
              $add_new.$("info")?.remove();
              $add_new.$("[body]").removeAttribute("disabled");
              $add_new.$("[display-name]")?.removeAttribute("disabled");
            }
            startSession();
          })
          .catch(function (error) {
            $add_new.$("info")?.remove();
            addCommentError("Network error");
          });
      });
      if ($comment) {
        $comment.replaceWith($add_new);
        $add_new.$("[body]").focus();
      } else if ($parent_comment) {
        $parent_comment.$(":scope > reply-wrapper").after($add_new);
        if (!display_name) {
          $add_new.$("[display-name]").focus();
        } else {
          $add_new.$("[body]").focus();
        }
      } else {
        $("comments").prepend($add_new);
      }
    };

    // Session start
    let display_name = "";
    let session_uuid = localStorage.getItem("session_uuid") || "";
    const startSession = () => {
      const postBody = {
        session_uuid,
        path,
      };
      if (reset_token_uuid) {
        postBody.reset_token_uuid = reset_token_uuid;
      }
      fetch("/session", {
        method: "POST",
        body: JSON.stringify(postBody),
      })
        .then((response) => response.json())
        .then(function (data) {
          session_uuid = data.session_uuid;
          localStorage.setItem("session_uuid", session_uuid);
          if (data.email) {
            signInSuccess(data.email);
            if (reset_token_uuid) {
              $("modal[password-reset]").style.display = "flex";
              $("modal-bg").style.display = "flex";
            }
          }
          if (data.display_name) {
            display_name = data.display_name;
          }
          if (data.error) {
            modalError(data.error);
          }
          if (data.path) {
            renderPage(data.path, data.articles, data.comments, data.add_new);
          }
        })
        .catch(function (error) {
          debug(error);
        });
    };
    startSession();

    // Menu
    $("header hamburger").on("click", () => {
      $("menu").style.display = "flex";
      $("modal-bg").style.display = "flex";
    });
    const menuCancel = () => {
      $("menu").style.display = "none";
      $("modal-bg").style.display = "none";
      $("sign-in error").style.display = "none";
      $("sign-in [type=email]").value = "";
      $("sign-in [type=password]").value = "";
    };
    $("menu [cancel]").on("click", menuCancel);
    $("modal-bg").on("click", menuCancel);
    $("menu links a").forEach(($el) => {
      $el.on("click", ($event) => {
        $event.preventDefault();
        menuCancel();
        const new_path = $el.getAttribute("href");
        if (path !== new_path) {
          path = new_path;
          history.pushState({}, "", path);
          loadingPage();
        }
        startSession();
      });
    });
    $("h1").forEach(($el) => {
      $el.on("click", ($event) => {
        $event.preventDefault();
        menuCancel();
        const new_path = $el.getAttribute("href");
        if (path !== new_path) {
          path = new_path;
          history.pushState({}, "", path);
          loadingPage();
        }
        startSession();
      });
    });

    // Generic modal info
    const modalInfoCancel = () => {
      $("modal[info]").style.display = "none";
      $("modal-bg").style.display = "none";
    };
    $("modal[info] [close]").on("click", modalInfoCancel);
    $("modal-bg").on("click", modalInfoCancel);
    const modalInfo = (message) => {
      $("modal[info] info").innerHTML = message;
      $("modal[info]").style.display = "flex";
      $("modal-bg").style.display = "flex";
    };

    // Generic modal error
    const modalErrorCancel = () => {
      $("modal[error]").style.display = "none";
      $("modal-bg").style.display = "none";
    };
    $("modal[error] [close]").on("click", modalErrorCancel);
    $("modal-bg").on("click", modalErrorCancel);
    const modalError = (message) => {
      $("modal[error] error").innerHTML = message;
      $("modal[error]").style.display = "flex";
      $("modal-bg").style.display = "flex";
    };

    // Sign Up / Sign In
    const signInError = (error) => {
      if (error) {
        $("sign-in error").style.display = "flex";
        $("sign-in error").innerHTML = error;
      } else {
        $("sign-in error").style.display = "none";
      }
    };
    const signInSuccess = (email) => {
      localStorage.setItem("email", email);
      $("sign-in").style.display = "none";
      $("signed-in").style.display = "flex";
    };
    $("sign-in [type=email]").on("focus", () => {
      signInError();
    });
    $("sign-in [type=password]").on("focus", () => {
      signInError();
    });
    $("sign-in [type=email]").on("keyup", (ev) => {
      if (ev.key === "Enter") {
        $("sign-in [submit]").click();
      }
    });
    $("sign-in [type=password]").on("keyup", (ev) => {
      if (ev.key === "Enter") {
        $("sign-in [submit]").click();
      }
    });
    $("sign-in [submit]").on("click", () => {
      signInError();
      const email = $("sign-in [type=email]").value;
      if (!$("sign-in [type=email]").checkValidity() || !email) {
        signInError("Please enter a valid email address");
        return;
      }
      const password = $("sign-in [type=password]").value;
      if (!password) {
        signInError("Please enter a password");
        return;
      }
      $("sign-in info").innerHTML = "Validating...";
      $("sign-in info").style.display = "flex";
      fetch("/session", {
        method: "POST",
        body: JSON.stringify({
          session_uuid,
          email,
          password,
        }),
      })
        .then((response) => response.json())
        .then(function (data) {
          $("sign-in info").style.display = "none";
          if (data.error || !data.success) {
            signInError(data.error || "Server error");
            return;
          }
          startSession();
          menuCancel();
        })
        .catch(function (error) {
          $("sign-in info").style.display = "none";
          signInError("Network error");
        });
    });
    $("signed-in button[sign-out]").on("click", () => {
      session_uuid = "";
      reset_token_uuid = "";
      startSession();
      $("sign-in").style.display = "flex";
      $("signed-in").style.display = "none";
    });

    // Forgot Password
    const passwordHelpCancel = () => {
      $("modal[password-help]").style.display = "none";
      $("modal-bg").style.display = "none";
      $("modal[password-help] error").style.display = "none";
      $("modal[password-help] [type=email]").value = "";
    };
    const passwordHelpError = (error) => {
      if (error) {
        $("modal[password-help] error").style.display = "flex";
        $("modal[password-help] error").innerHTML = error;
      } else {
        $("modal[password-help] error").style.display = "none";
      }
    };
    $("modal[password-help] [type=email]").on("focus", () => {
      passwordHelpError();
    });
    $("modal[password-help] [type=email]").on("keyup", (ev) => {
      if (ev.key === "Enter") {
        $("modal[password-help] [submit]").click();
      }
    });
    $("password-help").on("click", () => {
      menuCancel();
      $("modal-bg").style.display = "flex";
      $("modal[password-help]").style.display = "flex";
    });
    $("modal-bg").on("click", passwordHelpCancel);
    $("modal[password-help] [cancel]").on("click", passwordHelpCancel);
    $("modal[password-help] [submit]").on("click", () => {
      passwordHelpError();
      const email = $("modal[password-help] [type=email]").value;
      if (!$("modal[password-help] [type=email]").checkValidity() || !email) {
        passwordHelpError("Please enter a valid email address");
        return;
      }
      $("modal[password-help] info").innerHTML = "Validating...";
      $("modal[password-help] info").style.display = "flex";
      fetch("/session", {
        method: "POST",
        body: JSON.stringify({
          session_uuid,
          email,
        }),
      })
        .then((response) => response.json())
        .then(function (data) {
          $("modal[password-help] info").style.display = "none";
          if (data.error || !data.success) {
            passwordHelpError(data.error || "Server error");
            return;
          }
          passwordHelpCancel();
          modalInfo("An email was sent with password reset instructions.");
        })
        .catch(function (error) {
          $("modal[password-help] info").style.display = "none";
          passwordHelpError("Network error");
        });
    });

    // Resetting Password
    const passwordResetCancel = () => {
      $("modal[password-reset]").style.display = "none";
      $("modal-bg").style.display = "none";
      $("modal[password-reset] error").style.display = "none";
      $("modal[password-reset] [type=password]").value = "";
      reset_token_uuid = "";
    };
    const passwordResetError = (error) => {
      if (error) {
        $("modal[password-reset] error").style.display = "flex";
        $("modal[password-reset] error").innerHTML = error;
      } else {
        $("modal[password-reset] error").style.display = "none";
      }
    };
    $("modal[password-reset] [type=password]").on("focus", () => {
      passwordResetError();
    });
    $("modal[password-reset] [type=password]").on("keyup", (ev) => {
      if (ev.key === "Enter") {
        $("modal[password-reset] [submit]").click();
      }
    });
    $("modal-bg").on("click", passwordResetCancel);
    $("modal[password-reset] [cancel]").on("click", passwordResetCancel);
    $("modal[password-reset] [submit]").on("click", () => {
      passwordResetError();
      const password = $("modal[password-reset] [type=password]").value;
      if (!password) {
        passwordResetError("Please enter a new password");
        return;
      }
      $("modal[password-reset] info").innerHTML = "Validating...";
      $("modal[password-reset] info").style.display = "flex";
      fetch("/session", {
        method: "POST",
        body: JSON.stringify({
          session_uuid,
          reset_token_uuid,
          password,
        }),
      })
        .then((response) => response.json())
        .then(function (data) {
          $("modal[password-reset] info").style.display = "none";
          if (data.error || !data.success) {
            passwordResetError(data.error || "Server error");
            return;
          }
          passwordResetCancel();
          modalInfo("Your password has been set");
        })
        .catch(function (error) {
          $("modal[password-reset] info").style.display = "none";
          passwordResetError("Network error");
        });
    });

    // Limited markdown processing in a safe and readable way
    //
    // Supports:
    // ![alt](src)
    // >
    // #
    // [text](href)
    //
    const markdownToElements = (text) => {
      // Double line breaks seperate paragraphs
      const p_contents = text.split("\n\n");

      // Process one <p> tag at a time
      return p_contents.map((p_content) => {
        const p_element = document.createElement("p");

        // Support for >
        if (p_content.substr(0, 2) === "> ") {
          p_element.setAttribute("quote", "");
          p_content = p_content.replace(/> /g, "");
        }

        // Support for #
        if (p_content.substr(0, 2) === "# ") {
          p_element.setAttribute("bold", "");
          p_content = p_content.replace(/# /g, "");
        }

        let inserts = [];
        let imgs;
        let links;

        // Support for ![alt](src)
        let p_content_remaining = p_content;
        let offset = 0;
        while (
          (imgs = p_content_remaining.match(/!\[([^\]]*)\]\(([^\)]*)\)/))
        ) {
          const img_element = $(
            `
            img[alt=$1][src=$2]
            `,
            [imgs[1], imgs[2]],
          );
          let start = p_content_remaining.indexOf(imgs[0]);
          let finish = start + imgs[0].length;
          inserts.push([start + offset, finish + offset, img_element]);
          const to_replace = new Array(finish - start + 1).join("X");
          p_content =
            p_content.slice(0, start + offset) +
            to_replace +
            p_content.slice(finish + offset);
          offset += finish;
          p_content_remaining = p_content_remaining.slice(finish);
        }

        // Support for [text](href)
        p_content_remaining = p_content;
        offset = 0;
        while (
          (links = p_content_remaining.match(/\[([^\]]*)\]\(([^\)]*)\)/))
        ) {
          const big = Boolean(links[0] === p_content_remaining && offset === 0);
          const link_element = $(
            `
            a[href=$1][big=$2] $3
            `,
            [links[2], big, links[1]],
          );
          let start = p_content_remaining.indexOf(links[0]);
          let finish = start + links[0].length;
          inserts.push([start + offset, finish + offset, link_element]);
          const to_replace = new Array(finish - start + 1).join("Y");
          p_content =
            p_content.slice(0, start + offset) +
            to_replace +
            p_content.slice(finish + offset);
          offset += finish;
          p_content_remaining = p_content_remaining.slice(finish);
        }

        // Now create elements for all the text around those inserts
        offset = 0;
        inserts.forEach((insert) => {
          if (insert[0] - offset > 0) {
            p_element.appendChild(
              $(
                `
                span $1
                `,
                [p_content.slice(offset, insert[0])],
              ),
            );
          }
          p_element.appendChild(insert[2]);
          offset = insert[1];
        });
        if (offset < p_content.length) {
          p_element.appendChild(
            $(
              `
              span $1
              `,
              [p_content.slice(offset)],
            ),
          );
        }

        // Finally return the completed <p> tag in the array
        return p_element;
      });
    };
  </script>
</html>
